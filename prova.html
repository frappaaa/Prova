<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mappa con Google Sheet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 400px;
      }
      #locations {
        list-style: none;
        padding: 0;
        margin-bottom: 20px; /* Spazio per la tab bar */
      }
      #loadMore {
        margin-bottom: 100px;
      }
      .tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        display: flex;
        padding: 20px 0;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }
      .tab-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
        cursor: pointer;
      }

      .tab-item:nth-child(2) {
        border-radius: 50px;
        background: #374957;
        display: flex;
        padding: 10px 22px;
        align-items: center;
        gap: 10px;
      }

      .tab-item img {
        width: 24px;
        height: 24px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <h3>Lista dei Luoghi</h3>
    <ul id="locations"></ul>
    <button id="loadMore" style="display: none">Carica altri luoghi</button>

    <div class="tab-bar">
      <div class="tab-item">
        <img src="assets/fi-rr-map-marker.svg" alt="Map" />
      </div>
      <div class="tab-item">
        <img src="assets/fi-rr-plus.svg" alt="Add" />
      </div>
      <div class="tab-item">
        <img src="assets/fi-rr-calendar.svg" alt="Calendar" />
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const sheetId = "1gnIaoATtJAdtGC1ynplBo4o6TzAbF8Q47qpHzpGkB1U";
      const sheetRange = "A2:C"; // Modifica secondo il tuo foglio
      const apiKey = "AIzaSyDgMbIXrmolCkByiYrzHBYWQu-rLJCPPhs"; // Inserisci la tua API Key di Google
      const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;
      const geocodeUrl = "https://maps.googleapis.com/maps/api/geocode/json";
      const columnNameIndex = 0; // Indice della colonna contenente il nome del luogo
      const columnAddressIndex = 2; // Indice della colonna contenente l'indirizzo
      const columnInfoIndex = 3; // Indice della colonna contenente informazioni aggiuntive

      const map = L.map("map").setView([45.4642, 9.19], 12); // Milano come centro
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      async function geocodeAddress(address) {
        try {
          const response = await fetch(
            `${geocodeUrl}?address=${encodeURIComponent(address)}&key=${apiKey}`
          );
          const data = await response.json();
          if (data.status === "OK" && data.results.length > 0) {
            return data.results[0].geometry.location; // Restituisce latitudine e longitudine
          } else {
            console.error("Errore nella geocodifica:", data.status);
            return null;
          }
        } catch (error) {
          console.error("Errore nella richiesta di geocodifica:", error);
          return null;
        }
      }

      let currentIndex = 0;
      const batchSize = 5; // Numero di luoghi da caricare per volta
      let allLocations = [];

      async function loadLocations() {
        try {
          const response = await fetch(sheetUrl);
          const data = await response.json();
          allLocations = data.values || [];

          if (allLocations.length > 0) {
            await loadNextBatch();
            document.getElementById("loadMore").style.display = "block";
          }
        } catch (error) {
          console.error("Errore nel caricamento dei dati:", error);
        }
      }

      async function loadNextBatch() {
        const locationsList = document.getElementById("locations");
        const endIndex = Math.min(
          currentIndex + batchSize,
          allLocations.length
        );

        for (let i = currentIndex; i < endIndex; i++) {
          const row = allLocations[i];
          const name = row[columnNameIndex];
          const address = row[columnAddressIndex];

          if (name && address) {
            const location = await geocodeAddress(address);
            if (location) {
              L.marker([location.lat, location.lng])
                .addTo(map)
                .bindPopup(`<b>${name}</b><br>${address}`);

              const listItem = document.createElement("li");
              listItem.textContent = `${name} - ${address}`;
              locationsList.appendChild(listItem);
            }
          }
        }

        currentIndex = endIndex;
        if (currentIndex >= allLocations.length) {
          document.getElementById("loadMore").style.display = "none";
        }
      }

      loadLocations();
      document
        .getElementById("loadMore")
        .addEventListener("click", loadNextBatch);
    </script>
  </body>
</html>
